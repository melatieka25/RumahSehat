<!DOCTYPE html>
<html lang="en" xmlns:th="http://thymeleaf.org">
<head>
    <title>Statistik</title>
    <object th:include="fragments/fragment :: css" th:remove="tag"></object>
    <object th:include="fragments/fragment :: js" th:remove="tag"></object>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
	<script src="https://unpkg.com/multiple-select@1.5.2/dist/multiple-select.min.js"></script>
	<link rel="stylesheet" href="https://unpkg.com/multiple-select@1.5.2/dist/multiple-select.min.css">
</head>
<body>
<nav th:replace="fragments/fragment :: navbar (${'stats'})"></nav>
<div class="container" style="width:75%; padding-top:50px;">
    <div class="justify-content-center">
        <div style="margin: auto; padding-top: 10px; width: 85%; padding: 20px; text-align: center">
            <h2 style="font-weight: bold; padding-top: 10px;" >Statistik</h2>
            <br>
			<div class="card p-5">
				<div class="my-3 d-flex align-items-center">
					<label for="year" style="white-space: nowrap;">Jenis Chart:</label>
					<select class="form-select form-select-sm ms-2" id="chart-type" name="chart-type">
						<option value="0" th:selected="${chartType == 'line'}">Line Chart</option>
						<option value="1" th:selected="${chartType == 'bar'}">Bar Chart</option>
					</select>
				</div>
				<div class="mb-4" id="line-chart-opts" th:hidden="${chartType == 'bar'}">
					<form th:action="@{/statistics}" method="GET" class="d-flex align-items-center">
						<label for="year">Tahun:</label>
						<select class="form-select form-select-sm mx-2" id="year" name="year">
							<option value="" th:each="year : ${years}" th:text="${year}" th:value="${year}" th:selected="${year == currentYear}">None (Monthly View)</option>
						</select>
						
						<label for="month">Bulan:</label>
						<select class="form-select form-select-sm mx-2" id="month" name="month">
							<option value="" th:selected="${month == -1}">None (Monthly View)</option>
							<option value="1" th:selected="${month == 1}">Januari</option>
							<option value="2" th:selected="${month == 2}">Februari</option>
							<option value="3" th:selected="${month == 3}">Maret</option>
							<option value="4" th:selected="${month == 4}">April</option>
							<option value="5" th:selected="${month == 5}">Mei</option>
							<option value="6" th:selected="${month == 6}">Juni</option>
							<option value="7" th:selected="${month == 7}">Juli</option>
							<option value="8" th:selected="${month == 8}">Agustus</option>
							<option value="9" th:selected="${month == 9}">September</option>
							<option value="10" th:selected="${month == 10}">Oktober</option>
							<option value="11" th:selected="${month == 11}">November</option>
							<option value="12" th:selected="${month == 12}">Desember</option>
						</select>
						<button class="btn btn-primary" type="submit">Generate</button>
					</form>
				</div>
				<div class="mb-4" id="bar-chart-opts" th:hidden="${chartType == 'line'}">
					<form th:action="@{/statistics}" method="GET" class="d-flex align-items-center">
						<label for="data-source" style="white-space: nowrap;">Jenis Data:</label>
						<select class="form-select form-select-sm mx-2" id="data-source" name="data-source">
							<option value="0" th:selected="${dataSource == 0}">Kuantitas Tagihan</option>
							<option value="1" th:selected="${dataSource == 1}">Kuantitas Tagihan Terbayar</option>
						</select>
						
						<label for="age-range" style="white-space: nowrap;">Range Umur:</label>
						<select class="mx-2 full-width" id="age-range" name="age-range" multiple>
							<option value="0" th:selected="${#lists.contains(ageRangeSelected, 0)}">0-15</option>
							<option value="1" th:selected="${#lists.contains(ageRangeSelected, 1)}">16-30</option>
							<option value="2" th:selected="${#lists.contains(ageRangeSelected, 2)}">31-45</option>
							<option value="3" th:selected="${#lists.contains(ageRangeSelected, 3)}">46-60</option>
							<option value="4" th:selected="${#lists.contains(ageRangeSelected, 4)}">>= 61</option>
						</select>
						<button class="btn btn-primary" type="submit">Generate</button>
					</form>
				</div>
				<div class="chart-container pb-5 mb-5">
					<canvas id="chart"></canvas>
					<script th:if="${chartType == 'line'}" th:inline="javascript">
						const ctx = document.getElementById('chart').getContext('2d');
						const chart = new Chart(ctx, {
							type: 'line',
							data: {
								labels: [[${labels}]],
								datasets: [{
									label: 'Umur 0-15',
									data: [[${data[0]}]],
									backgroundColor: [
										'rgba(255, 99, 132, 0.2)'
									],
									borderColor: [
										'rgba(255, 99, 132, 1)'
									],
									borderWidth: 2
								}, {
									label: 'Umur 16-30',
									data: [[${data[1]}]],
									backgroundColor: [
										'rgba(54, 162, 235, 0.2)'
									],
									borderColor: [
										'rgba(54, 162, 235, 1)'
									],
									borderWidth: 2
								}, {
									label: 'Umur 31-45',
									data: [[${data[2]}]],
									backgroundColor: [
										'rgba(255, 206, 86, 0.2)'
									],
									borderColor: [
										'rgba(255, 206, 86, 1)'
									],
									borderWidth: 2
								}, {
									label: 'Umur 45-60',
									data: [[${data[3]}]],
									backgroundColor: [
										'rgba(106, 171, 97, 0.2)'
									],
									borderColor: [
										'rgba(106, 171, 97, 1)'
									],
									borderWidth: 1
								}, {
									label: 'Umur >= 61',
									data: [[${data[0]}]],
									backgroundColor: [
										'rgba(153, 102, 255, 0.2)'
									],
									borderColor: [
										'rgba(153, 102, 255, 1)'
									],
									borderWidth: 2
								}]
							},
							options: {
								scales: {
									y: {
										beginAtZero: true,
										ticks: {
											precision: 0
										}
									}
								},
								plugins: {
									title: {
										display: true,
										text: 'Jumlah Tagihan Yang Dibuat'
									}
								}
							}
						});
					</script>
					<script th:if="${chartType == 'bar'}" th:inline="javascript">
						const bgColors = ['rgba(255, 99, 132, 0.2)', 'rgba(54, 162, 235, 0.2)', 'rgba(255, 206, 86, 0.2)', 'rgba(106, 171, 97, 0.2)', 'rgba(153, 102, 255, 0.2)'];
						const bdColors = ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)', 'rgba(106, 171, 97, 1)', 'rgba(153, 102, 255, 1)'];
						
						let labels = [[${labels}]];
						let data = [[${data}]];
						let dataLabel = [[${dataLabel}]];
						
						const ctx = document.getElementById('chart').getContext('2d');
						const chart = new Chart(ctx, {
							type: 'bar',
							data: {
								labels: labels,
								datasets: [{
									label: dataLabel,
									data: data,
									backgroundColor: bgColors,
									borderColor: bdColors,
									borderWidth: 1
								}]
							},
							options: {
								scales: {
									y: {
										beginAtZero: true,
										ticks: {
											precision: 0
										}
									}
								},
								plugins: {
									title: {
										display: true,
										text: dataLabel
									}
								}
							}
						});
					</script>
				</div>
			</div>
        </div>
    </div>
</div>
</div>

<script type="text/javascript">
    $(document).ready(function() {
        $('#age-range').multipleSelect();
    });
	
	$('#chart-type').on('change', function() {
		console.log( this.value );
		if(this.value == 0) {
			$('#line-chart-opts').attr('hidden', false);
			$('#bar-chart-opts').attr('hidden', true);
		} else {
			$('#line-chart-opts').attr('hidden', true);
			$('#bar-chart-opts').attr('hidden', false);
		}
	});
</script>

<style>
	.full-width {
		width: 100% !important;
	}
</style>

</body>
</html>